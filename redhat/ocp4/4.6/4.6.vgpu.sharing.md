# vGPU sharing

- 重点在 allocate，这个是 kubelet请求device plugin，给出了一个device list，让device plugin给出命令参数，然后kubelet去启动。
- 那么重点，就在kubelet怎么算出来这个device list的，我们就改这部分就好了，似乎是scheduler
- 可以直接试试aliyun， 先看看scheduler能不能用。
  - 不行，ocp的scheduler扩展给封死了。
  - 定制openshift的sheduler

```bash
oc image mirror registry.cn-hangzhou.aliyuncs.com/acs/k8s-gpushare-schd-extender:1.11-d170d8a  quay.io/wangzheng422/qimgs:k8s-gpushare-schd-extender-1.11-d170d8a

curl -O https://raw.githubusercontent.com/AliyunContainerService/gpushare-scheduler-extender/master/config/gpushare-schd-extender.yaml
kubectl create -f gpushare-schd-extender.yaml

oc create configmap -n openshift-config --from-file=scheduler-policy-config.json scheduler-policy

oc patch Scheduler cluster --type='merge' -p '{"spec":{"policy":{"name":"scheduler-policy"}}}' --type=merge

```
## ocp base image download

我们需要扩展 scheduler extender，就需要从源代码级别重新编译openshift相关组件，想编译，就要下载基础镜像，而下载基础镜像，需要账号密码。现在已知有2种方法，一个是向openshift-sme@redhat.com申请github账号权限，另外一个是在redhat公司内网下载，以下分别说

### openshift-sme

参照这个文档，申请自己的github账号，能加入 openshift organization。

https://source.redhat.com/groups/public/atomicopenshift/atomicopenshift_wiki/openshift_onboarding_checklist_for_github

如果批准了，就做下面的事情：

Step 1: 访问openshift cluster： https://console-openshift-console.apps.ci.l2s4.p1.openshiftapps.com
Step 2： 用您的github账号登陆。
Step3： 拷贝登陆openshift cluster的命令， 类似: oc login ....
Step4: 登陆openshift cluster成功后，登陆registry： docker login registry.ci.openshift.org -u <github-id> -p $(oc whoami -t)
Step5: docker pull 测试一下能否pull下来base image.

```bash
podman pull registry.ci.openshift.org/ocp/4.6:base
podman pull registry.ci.openshift.org/ocp/builder:rhel-8-golang-1.15-openshift-4.6

```

### registry-proxy.engineering.redhat.com

另外的这种方案，不需要账号，但是需要在红帽的内网做。

首先去下载 https://password.corp.redhat.com/RH-IT-Root-CA.crt 

然后把这个 RH-IT-Root-CA.crt 导入系统
```bash
/bin/cp -f RH-IT-Root-CA.crt  /etc/pki/ca-trust/source/anchors/
update-ca-trust extract

```

然后下载镜像
```bash
podman pull registry-proxy.engineering.redhat.com/rh-osbs/openshift-ose-base:v4.6.0

```

## cluster-kube-scheduler-operator

我们试图定制scheduler来满足阿里或者腾讯的gpu sharing对scheduler extender的需求

关键看  /etc/kubernetes/manifests/kube-scheduler-pod.yaml 是怎么创建的，因为kube-scheduler是一个static pod，他是靠上面的文件，通过kubelet来创建的。

改 pkg/operator/targetconfigcontroller/targetconfigcontroller.go 这里的代码，应该就可以了。
```bash


```



## others
首先，去 https://post-office.corp.redhat.com/mailman/listinfo/openshift-sme 申请加入这个邮件列表。

然后，向 openshift-sme@redhat.com 发邮件，申请自己的github账号，能加入 openshift organization。

```yaml
apiVersion: nvidia.com/v1
kind: ClusterPolicy
metadata:
  name: gpu-cluster-policy
spec:
  dcgmExporter:
    nodeSelector: {}
    imagePullSecrets: []
    resources: {}
    affinity: {}
    podSecurityContext: {}
    repository: nvcr.io/nvidia/k8s
    securityContext: {}
    version: 'sha256:85016e39f73749ef9769a083ceb849cae80c31c5a7f22485b3ba4aa590ec7b88'
    image: dcgm-exporter
    tolerations: []
  devicePlugin:
    nodeSelector: {}
    imagePullSecrets: []
    resources: {}
    affinity: {}
    podSecurityContext: {}
    repository: nvcr.io/nvidia
    securityContext: {}
    version: 'sha256:f7bf5955a689fee4c1c74dc7928220862627adc97e00a4b585f9c31965e79625'
    image: k8s-device-plugin
    tolerations: []
    args:
      - '--mig-strategy=single'
      - '--pass-device-specs=false'
      - '--fail-on-init-error=true'
      - '--device-list-strategy=envvar'
      - '--nvidia-driver-root=/run/nvidia/driver'
  driver:
    nodeSelector: {}
    imagePullSecrets: []
    resources: {}
    affinity: {}
    podSecurityContext: {}
    repository: nvcr.io/nvidia
    securityContext: {}
    repoConfig:
      configMapName: repo-config
      destinationDir: /etc/yum.repos.d
    version: 'sha256:324e9dc265dec320207206aa94226b0c8735fd93ce19b36a415478c95826d934'
    image: driver
    tolerations: []
  gfd:
    nodeSelector: {}
    imagePullSecrets: []
    resources: {}
    affinity: {}
    podSecurityContext: {}
    repository: nvcr.io/nvidia
    securityContext: {}
    version: 'sha256:8d068b7b2e3c0b00061bbff07f4207bd49be7d5bfbff51fdf247bc91e3f27a14'
    image: gpu-feature-discovery
    sleepInterval: 60s
    tolerations: []
    migStrategy: single
  operator:
    defaultRuntime: crio
    deployGFD: true
    validator:
      image: cuda-sample
      imagePullSecrets: []
      repository: nvcr.io/nvidia/k8s
      version: 'sha256:2a30fe7e23067bc2c3f8f62a6867702a016af2b80b9f6ce861f3fea4dfd85bc2'
  toolkit:
    nodeSelector: {}
    imagePullSecrets: []
    resources: {}
    affinity: {}
    podSecurityContext: {}
    repository: nvcr.io/nvidia/k8s
    securityContext: {}
    version: 'sha256:81295a9eca36cbe5d94b80732210b8dc7276c6ef08d5a60d12e50479b9e542cd'
    image: container-toolkit
    tolerations: []



```